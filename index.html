<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>testing screenshot browser</h1>
    <p>asddddddddddddd!!!!!111</p>
    
  <button class="fire-fun">test for firefox</button>
  <button class="fire-mob">test for mob</button>

<script>
  async function captureViewportScreenshot() {
    try {
      // Open the screen-sharing prompt
      const stream = await navigator.mediaDevices.getDisplayMedia({ video: true,
                                                                    audio: false,
                                                                  preferCurrentTab: true });

      // Create small timeframe to not capture the prompt
      await new Promise(resolve => setTimeout(resolve, 300));

      // Capture the screen
      const videoTrack = stream.getVideoTracks()[0];
      const imageCapture = new ImageCapture(videoTrack);
      const bitmap = await imageCapture.grabFrame();
      const canvas = document.createElement('canvas');
      canvas.width = bitmap.width;
      canvas.height = bitmap.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(bitmap, 0, 0);
      const screenshot = canvas.toDataURL('image/png');
      const image = new Image();
      image.src = screenshot;
      
      // Create modal window
      const modal = document.createElement('div');
      modal.className = 'screenshot-modal';
      const modalBg = document.createElement('div');
      modalBg.className = 'screenshot-modal-bg';
      const modalContent = document.createElement('div');
      modalContent.className = 'screenshot-modal-content';
      modal.appendChild(modalBg);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);

      // Add image to modal content
      modalContent.appendChild(image);

      // Create download button
      const downloadBtn = document.createElement('a');
      downloadBtn.className = 'screenshot-download-btn';
      downloadBtn.href = screenshot;
      downloadBtn.download = 'screenshot.png';
      downloadBtn.innerHTML = 'Download';
      modalContent.appendChild(downloadBtn);

      // Close modal on click outside
      modalBg.addEventListener('click', () => {
        document.body.removeChild(modal);
      });

      videoTrack.stop();
      stream.getTracks().forEach(track => track.stop());
    } catch (error) {
    console.log('Error capturing screenshot: ', error);
    }
}

async function captureViewportMobile() {
  try {
    const canvas = document.createElement('canvas');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const ctx = canvas.getContext('2d');

    // Determine which method to use based on the platform
    const platform = navigator.platform.toLowerCase();
    if (platform.includes('win') || platform.includes('mac') || platform.includes('linux')) {
      const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
      const videoTrack = stream.getVideoTracks()[0];
      const imageCapture = new ImageCapture(videoTrack);
      const bitmap = await imageCapture.grabFrame();
      ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
      videoTrack.stop();
      stream.getTracks().forEach(track => track.stop());
    } else {
      const dataUrl = await new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"><foreignObject width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml">' + document.documentElement.innerHTML + '</div></foreignObject></svg>';
        img.onload = () => {
          const svgCanvas = document.createElement('canvas');
          svgCanvas.width = img.width;
          svgCanvas.height = img.height;
          const svgCtx = svgCanvas.getContext('2d');
          svgCtx.drawImage(img, 0, 0);
          const dataUrl = svgCanvas.toDataURL('image/png');
          resolve(dataUrl);
        };
      });
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.src = dataUrl;
      img.onload = () => {
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      };
    }

    const screenshot = canvas.toDataURL('image/png');
    const image = new Image();
    image.src = screenshot;
    
    // Create modal window
    const modal = document.createElement('div');
    modal.className = 'screenshot-modal';
    const modalBg = document.createElement('div');
    modalBg.className = 'screenshot-modal-bg';
    const modalContent = document.createElement('div');
    modalContent.className = 'screenshot-modal-content';
    modal.appendChild(modalBg);
    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    // Add image to modal content
    modalContent.appendChild(image);

    // Create download button
    const downloadBtn = document.createElement('a');
    downloadBtn.className = 'screenshot-download-btn';
    downloadBtn.href = screenshot;
    downloadBtn.download = 'screenshot.png';
    downloadBtn.innerHTML = 'Download';
    modalContent.appendChild(downloadBtn);

    // Close modal on click outside
    modalBg.addEventListener('click', () => {
      document.body.removeChild(modal);
    });
  } catch (error) {
    console.log('Error capturing screenshot: ', error);
  }
}


// async function captureMobileScreenshot() {
//   try {
//     const constraints = {
//       video: {
//         mediaSource: 'screen',
//         width: { min: 640, ideal: 1280, max: 1920 },
//         height: { min: 480, ideal: 720, max: 1080 },
//         aspectRatio: 1.777777778,
//       },
//     };
//     const stream = await navigator.mediaDevices.getUserMedia(constraints);
//     const videoTrack = stream.getVideoTracks()[0];
//     const imageCapture = new ImageCapture(videoTrack);
//     const bitmap = await imageCapture.grabFrame();
//     const canvas = document.createElement('canvas');
//     canvas.width = bitmap.width;
//     canvas.height = bitmap.height;
//     const ctx = canvas.getContext('2d');
//     ctx.drawImage(bitmap, 0, 0);
//     const screenshot = canvas.toDataURL('image/png');
//     const image = new Image();
//     image.src = screenshot;

//     // Create modal window
//     const modal = document.createElement('div');
//     modal.className = 'screenshot-modal';
//     const modalBg = document.createElement('div');
//     modalBg.className = 'screenshot-modal-bg';
//     const modalContent = document.createElement('div');
//     modalContent.className = 'screenshot-modal-content';
//     modal.appendChild(modalBg);
//     modal.appendChild(modalContent);
//     document.body.appendChild(modal);

//     // Add image to modal content
//     modalContent.appendChild(image);

//     // Create download button
//     const downloadBtn = document.createElement('a');
//     downloadBtn.className = 'screenshot-download-btn';
//     downloadBtn.href = screenshot;
//     downloadBtn.download = 'screenshot.png';
//     downloadBtn.innerHTML = 'Download';
//     modalContent.appendChild(downloadBtn);

//     // Close modal on click outside
//     modalBg.addEventListener('click', () => {
//       document.body.removeChild(modal);
//     });

//     videoTrack.stop();
//     stream.getTracks().forEach(track => track.stop());
//   } catch (error) {
//     console.log('Error capturing screenshot: ', error);
//   }
// }

const btn = document.querySelector('.fire-fun');
const btnMob = document.querySelector('.fire-mob');
btn.addEventListener('click', captureViewportScreenshot);

btnMob.addEventListener('click', captureViewportMobile);

    </script>
</body>
</html>
